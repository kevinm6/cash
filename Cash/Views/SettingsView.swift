//
//  SettingsView.swift
//  Cash
//
//  Created by Michele Broggi on 25/11/25.
//

import SwiftData
import SwiftUI
import UniformTypeIdentifiers

#if ENABLE_ICLOUD
    import CloudKit
#endif

// MARK: - Bundle Extension for App Icon

extension Bundle {
    var icon: UIImage? {
        if let icons = infoDictionary?["CFBundleIcons"] as? [String: Any],
            let primaryIcon = icons["CFBundlePrimaryIcon"] as? [String: Any],
            let iconFiles = primaryIcon["CFBundleIconFiles"] as? [String],
            let lastIcon = iconFiles.last
        {
            return UIImage(named: lastIcon)
        }
        return nil
    }
}

// MARK: - Settings Tab

enum SettingsTab: String, CaseIterable, Identifiable {
    case general = "general"
    case data = "data"
    case about = "about"

    var id: String { rawValue }

    var labelKey: LocalizedStringKey {
        switch self {
        case .general:
            return "General"
        case .data:
            return "Data"
        case .about:
            return "About"
        }
    }

    var iconName: String {
        switch self {
        case .general:
            return "gearshape.fill"
        case .data:
            return "externaldrive.fill"
        case .about:
            return "info.circle.fill"
        }
    }
}

// MARK: - Settings View

struct SettingsView: View {
    @Environment(AppSettings.self) private var settings
    @Environment(\.modelContext) private var modelContext
    let appState: AppState
    let dismissSettings: () -> Void

    @State private var selectedTab: SettingsTab = .general
    @State private var showingFirstResetAlert = false
    @State private var showingSecondResetAlert = false
    @State private var showingExportFormatPicker = false
    @State private var showingImportConfirmation = false
    @State private var showingImportFilePicker = false
    @State private var showingExportSuccess = false
    @State private var showingImportSuccess = false
    @State private var showingError = false
    @State private var errorMessage = ""
    @State private var importResult: (accountsCount: Int, transactionsCount: Int) = (0, 0)
    @State private var exportData: Data?
    @State private var exportFilename = ""
    @State private var showingFileExporter = false

    @Query private var accounts: [Account]
    @Query private var transactions: [Transaction]

    var body: some View {
        NavigationStack {
            List {
                GeneralSettingsTabContent()
                DataSettingsTabContent(
                    showingExportFormatPicker: $showingExportFormatPicker,
                    showingImportConfirmation: $showingImportConfirmation,
                    showingFirstResetAlert: $showingFirstResetAlert
                )
                AboutSettingsTabContent()
            }
            .navigationTitle(String(localized: "Settings"))
            .toolbar {
                ToolbarItem(placement: .cancellationAction) {
                    Button(String(localized: "Close")) {
                        dismissSettings()
                    }
                }
            }
        }
        .id(settings.refreshID)
        .overlay {
            if appState.isLoading {
                LoadingOverlayView(message: appState.loadingMessage)
            }
        }
        .alert(String(localized: "Reset all data?"), isPresented: $showingFirstResetAlert) {
            Button(String(localized: "Cancel"), role: .cancel) {}
            Button(String(localized: "Continue"), role: .destructive) {
                showingSecondResetAlert = true
            }
        } message: {
            Text(
                String(
                    localized:
                        "This will permanently delete all your accounts and transactions. This action cannot be undone."
                ))
        }
        .alert(
            String(localized: "Are you absolutely sure?"), isPresented: $showingSecondResetAlert
        ) {
            Button(String(localized: "Cancel"), role: .cancel) {}
            Button(String(localized: "Delete everything"), role: .destructive) {
                resetAllData()
            }
        } message: {
            Text(String(localized: "All data will be permanently deleted."))
        }
        .sheet(isPresented: $showingExportFormatPicker) {
            ExportFormatPickerView { format in
                exportData(format: format)
            }
        }
        .alert(String(localized: "Import data?"), isPresented: $showingImportConfirmation) {
            Button(String(localized: "Cancel"), role: .cancel) {}
            Button(String(localized: "Continue")) {
                showingImportFilePicker = true
            }
        } message: {
            Text(
                String(
                    localized:
                        "Importing will replace all existing data. Make sure to export your current data first if needed."
                ))
        }
        .fileImporter(
            isPresented: $showingImportFilePicker,
            allowedContentTypes: [.data],
            allowsMultipleSelection: false
        ) { result in
            handleImport(result: result)
        }
        .alert(String(localized: "Export successful"), isPresented: $showingExportSuccess) {
            Button(String(localized: "OK"), role: .cancel) {}
        } message: {
            Text(String(localized: "Your data has been exported successfully."))
        }
        .alert(String(localized: "Import successful"), isPresented: $showingImportSuccess) {
            Button(String(localized: "OK"), role: .cancel) {}
        } message: {
            Text(
                String(
                    localized:
                        "Imported \(importResult.accountsCount) accounts and \(importResult.transactionsCount) transactions."
                ))
        }
        .alert(String(localized: "Error"), isPresented: $showingError) {
            Button(String(localized: "OK"), role: .cancel) {}
        } message: {
            Text(errorMessage)
        }
        .fileExporter(
            isPresented: $showingFileExporter,
            document: ExportDocument(data: exportData ?? Data()),
            contentType: .data,
            defaultFilename: exportFilename
        ) { result in
            switch result {
            case .success:
                showingExportSuccess = true
            case .failure(let error):
                errorMessage = error.localizedDescription
                showingError = true
            }
        }
    }

    // MARK: - Export

    private func exportData(format: ExportFormat) {
        do {
            let data: Data

            switch format {
            case .cashBackup:
                data = try DataExporter.exportCashBackup(
                    accounts: accounts, transactions: transactions)
            case .ofx:
                data = try DataExporter.exportOFX(accounts: accounts, transactions: transactions)
            }

            let filename = DataExporter.generateFilename(for: format)

            self.exportData = data
            self.exportFilename = filename
            self.showingFileExporter = true
        } catch {
            errorMessage = error.localizedDescription
            showingError = true
        }
    }

    // MARK: - Import

    private func handleImport(result: Result<[URL], Error>) {
        switch result {
        case .success(let urls):
            guard let url = urls.first else { return }

            guard url.startAccessingSecurityScopedResource() else {
                errorMessage = "Cannot access the selected file"
                showingError = true
                return
            }

            appState.isLoading = true
            appState.loadingMessage = String(localized: "Importing data...")

            Task.detached(priority: .userInitiated) {
                do {
                    let data = try Data(contentsOf: url)
                    url.stopAccessingSecurityScopedResource()

                    await MainActor.run {
                        // Delete existing data first
                        deleteAllData()

                        do {
                            let result = try DataExporter.importCashBackup(
                                from: data, into: modelContext)

                            importResult = result
                            appState.isLoading = false
                            showingImportSuccess = true
                        } catch {
                            appState.isLoading = false
                            errorMessage = error.localizedDescription
                            showingError = true
                        }
                    }
                } catch {
                    url.stopAccessingSecurityScopedResource()
                    await MainActor.run {
                        appState.isLoading = false
                        errorMessage = error.localizedDescription
                        showingError = true
                    }
                }
            }

        case .failure(let error):
            errorMessage = error.localizedDescription
            showingError = true
        }
    }

    private func deleteAllData() {
        let attachments = (try? modelContext.fetch(FetchDescriptor<Attachment>())) ?? []
        for attachment in attachments { modelContext.delete(attachment) }

        let rules = (try? modelContext.fetch(FetchDescriptor<RecurrenceRule>())) ?? []
        for rule in rules { modelContext.delete(rule) }

        let entries = (try? modelContext.fetch(FetchDescriptor<Entry>())) ?? []
        for entry in entries { modelContext.delete(entry) }

        let txns = (try? modelContext.fetch(FetchDescriptor<Transaction>())) ?? []
        for txn in txns { modelContext.delete(txn) }

        let accts = (try? modelContext.fetch(FetchDescriptor<Account>())) ?? []
        for acct in accts { modelContext.delete(acct) }

        let budgets = (try? modelContext.fetch(FetchDescriptor<Budget>())) ?? []
        for budget in budgets { modelContext.delete(budget) }

        let loans = (try? modelContext.fetch(FetchDescriptor<Loan>())) ?? []
        for loan in loans { modelContext.delete(loan) }
    }

    // MARK: - Reset

    private func resetAllData() {
        dismissSettings()

        appState.isLoading = true
        appState.loadingMessage = String(localized: "Erasing data...")

        Task {
            try? await Task.sleep(nanoseconds: 300_000_000)

            Task.detached(priority: .background) {
                await deleteAllData()

                await MainActor.run {
                    AppConfiguration.markSetupNeeded(in: modelContext)

                    do {
                        try modelContext.save()
                    } catch {
                        print("Error saving after delete: \(error)")
                    }

                    appState.isLoading = false
                    AppState.requestShowWelcome()
                }
            }
        }
    }
}

// MARK: - General Settings Tab Content

struct GeneralSettingsTabContent: View {
    @Environment(AppSettings.self) private var settings
    @State private var showingRestartAlert = false

    var body: some View {
        @Bindable var settings = settings

        Section("Appearance") {
            Picker("Theme", selection: $settings.theme) {
                ForEach(AppTheme.allCases) { theme in
                    Text(theme.labelKey).tag(theme)
                }
            }
            .pickerStyle(.menu)

            Picker("Language", selection: $settings.language) {
                let languagesOrder: [AppLanguage] = [
                    .system, .english, .italian, .spanish, .french, .german,
                ]
                ForEach(languagesOrder) { language in
                    Text(language.labelKey).tag(language)
                }
            }
            .pickerStyle(.menu)
            .onChange(of: settings.language) {
                if settings.needsRestart {
                    showingRestartAlert = true
                }
            }
        }

        Section {
            Toggle("Show live ETF quotes", isOn: $settings.showLiveQuotes)
        } header: {
            Text("Investments")
        } footer: {
            Text(
                "When enabled, displays real-time price quotes for investment accounts with an ISIN code. This setting syncs across your devices via iCloud."
            )
        }
        .alert("Restart required", isPresented: $showingRestartAlert) {
            Button("OK") {
                settings.needsRestart = false
            }
        } message: {
            Text("Please close and reopen the app to apply language changes.")
        }
    }
}

// MARK: - Data Settings Tab Content

struct DataSettingsTabContent: View {
    @Binding var showingExportFormatPicker: Bool
    @Binding var showingImportConfirmation: Bool
    @Binding var showingFirstResetAlert: Bool

    #if ENABLE_ICLOUD
        @State private var cloudManager = CloudKitManager.shared
        @State private var showingRestartAlert = false

        private var hasICloudAccount: Bool {
            FileManager.default.ubiquityIdentityToken != nil
        }
    #endif

    var body: some View {
        #if ENABLE_ICLOUD
            Section {
                Toggle(
                    "Enable iCloud sync",
                    isOn: Binding(
                        get: { cloudManager.isEnabled },
                        set: { newValue in
                            cloudManager.isEnabled = newValue
                            if cloudManager.needsRestart {
                                showingRestartAlert = true
                            }
                        }
                    )
                )
                .disabled(!cloudManager.isAvailable)

                if cloudManager.isEnabled {
                    LabeledContent("Status") {
                        HStack(spacing: 6) {
                            Circle()
                                .fill(
                                    cloudManager.accountStatus == .available
                                        ? Color.green : Color.orange
                                )
                                .frame(width: 8, height: 8)
                            Text(cloudManager.accountStatusDescription)
                                .foregroundStyle(.secondary)
                        }
                    }

                    LabeledContent("Storage used") {
                        if cloudManager.isLoadingStorage {
                            ProgressView()
                                .scaleEffect(0.7)
                        } else {
                            Text(cloudManager.formattedStorageUsed)
                                .foregroundStyle(.secondary)
                        }
                    }
                }
            } header: {
                Text("iCloud Sync")
            } footer: {
                if !hasICloudAccount {
                    Text("Sign in to iCloud in Settings to enable sync.")
                } else {
                    Text("Sync your data across all your devices.")
                }
            }
            .onAppear {
                Task {
                    await cloudManager.checkAccountStatus()
                    await cloudManager.fetchStorageUsed()
                }
            }
            .alert("Restart required", isPresented: $showingRestartAlert) {
                Button("OK") {
                    cloudManager.needsRestart = false
                }
            } message: {
                Text("Please close and reopen the app to apply iCloud changes.")
            }
        #endif

        Section {
            Button {
                showingExportFormatPicker = true
            } label: {
                Label("Export data", systemImage: "square.and.arrow.up")
            }

            Button {
                showingImportConfirmation = true
            } label: {
                Label("Import data", systemImage: "square.and.arrow.down")
            }
        } header: {
            Text("Export / Import")
        } footer: {
            Text(
                "Export your data as JSON (full backup) or OFX (standard bank format). Import will replace all existing data."
            )
        }

        Section {
            Button(role: .destructive) {
                showingFirstResetAlert = true
            } label: {
                Label("Reset all data", systemImage: "trash.fill")
            }
        } header: {
            Text("Danger zone")
        } footer: {
            Text("This will delete all accounts and transactions.")
        }
    }
}

// MARK: - About Settings Tab Content

struct AboutSettingsTabContent: View {
    @State private var showingLicense = false

    private var appVersion: String {
        Bundle.main.infoDictionary?["CFBundleShortVersionString"] as? String ?? ""
    }

    var body: some View {
        Section {
            VStack(spacing: 12) {
                if let icon = Bundle.main.icon {
                    Image(uiImage: icon)
                        .resizable()
                        .frame(width: 64, height: 64)
                        .clipShape(RoundedRectangle(cornerRadius: 16))
                } else {
                    Image(systemName: "app.fill")
                        .resizable()
                        .frame(width: 64, height: 64)
                        .foregroundStyle(.blue)
                        .clipShape(RoundedRectangle(cornerRadius: 16))
                }

                VStack(spacing: 4) {
                    Text(String(localized: "Cash"))
                        .font(.title2)
                        .fontWeight(.semibold)

                    Text("Version \(appVersion)")
                        .font(.subheadline)
                        .foregroundStyle(.secondary)
                }

                Text(
                    String(
                        localized:
                            "A personal finance management application inspired by Gnucash, built with SwiftUI and SwiftData."
                    )
                )
                .font(.subheadline)
                .foregroundStyle(.secondary)
                .multilineTextAlignment(.center)

                Button {
                    showingLicense = true
                } label: {
                    Text(String(localized: "Â© 2025 Michele Broggi"))
                        .font(.caption)
                        .foregroundStyle(.secondary)
                }
                .buttonStyle(.plain)
            }
            .frame(maxWidth: .infinity)
            .padding(.vertical, 12)
        }

        Section {
            Link(destination: URL(string: "https://github.com/thesmokinator/cash")!) {
                Label(String(localized: "Project website"), systemImage: "link")
            }

            Link(
                destination: URL(
                    string: "https://github.com/thesmokinator/cash/blob/main/PRIVACY.md")!
            ) {
                Label(String(localized: "Privacy policy"), systemImage: "hand.raised.fill")
            }
        } header: {
            Text(String(localized: "Links"))
        }
        .sheet(isPresented: $showingLicense) {
            LicenseView()
        }
    }
}

// MARK: - License View

struct LicenseView: View {
    @Environment(\.dismiss) private var dismiss

    private var licenseText: String {
        guard let url = Bundle.main.url(forResource: "LICENSE", withExtension: "md"),
            let content = try? String(contentsOf: url, encoding: .utf8)
        else {
            return "License file not found"
        }
        return content
    }

    var body: some View {
        NavigationStack {
            ScrollView {
                Text(licenseText)
                    .font(.system(.caption, design: .monospaced))
                    .foregroundStyle(.secondary)
                    .textSelection(.enabled)
                    .frame(maxWidth: .infinity, alignment: .leading)
                    .padding()
            }
            .navigationTitle("MIT License")
            .navigationBarTitleDisplayMode(.inline)
            .toolbar {
                ToolbarItem(placement: .confirmationAction) {
                    Button("Close") {
                        dismiss()
                    }
                }
            }
        }
    }
}

// MARK: - Export Format Picker

struct ExportFormatPickerView: View {
    @Environment(\.dismiss) private var dismiss
    let onSelect: (ExportFormat) -> Void

    var body: some View {
        NavigationStack {
            List {
                Section {
                    Text(
                        String(
                            localized:
                                "Choose the format for exporting your financial data. JSON is recommended for full backup and restore, while OFX is the standard bank format for importing into other applications."
                        )
                    )
                    .font(.subheadline)
                    .foregroundStyle(.secondary)
                }

                Section(String(localized: "Available formats")) {
                    ForEach(ExportFormat.allCases) { format in
                        Button {
                            dismiss()
                            onSelect(format)
                        } label: {
                            HStack(spacing: 16) {
                                ZStack {
                                    RoundedRectangle(cornerRadius: 8)
                                        .fill(
                                            format == .cashBackup
                                                ? Color.blue.opacity(0.1) : Color.green.opacity(0.1)
                                        )
                                        .frame(width: 48, height: 48)

                                    Image(systemName: format.iconName)
                                        .font(.title2)
                                        .foregroundStyle(format == .cashBackup ? .blue : .green)
                                }

                                VStack(alignment: .leading, spacing: 4) {
                                    Text(format.localizedName)
                                        .font(.headline)

                                    Text(format.description)
                                        .font(.subheadline)
                                        .foregroundStyle(.secondary)
                                        .lineLimit(2)
                                }

                                Spacer()

                                Image(systemName: "chevron.right")
                                    .font(.caption)
                                    .foregroundStyle(.tertiary)
                            }
                            .contentShape(Rectangle())
                        }
                        .buttonStyle(.plain)
                        .listRowInsets(EdgeInsets(top: 12, leading: 16, bottom: 12, trailing: 16))
                    }
                }
            }
            .navigationTitle(String(localized: "Export data"))
            .navigationBarTitleDisplayMode(.inline)
            .toolbar {
                ToolbarItem(placement: .cancellationAction) {
                    Button(String(localized: "Cancel")) {
                        dismiss()
                    }
                }
            }
        }
        .presentationDetents([.medium])
    }
}

// MARK: - Export Document

struct ExportDocument: FileDocument {
    static var readableContentTypes: [UTType] { [.data] }

    let data: Data

    init(data: Data) {
        self.data = data
    }

    init(configuration: ReadConfiguration) throws {
        guard let data = configuration.file.regularFileContents else {
            throw CocoaError(.fileReadCorruptFile)
        }
        self.data = data
    }

    func fileWrapper(configuration: WriteConfiguration) throws -> FileWrapper {
        FileWrapper(regularFileWithContents: data)
    }
}
